<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>I Like Turtles</title>
	<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <style>
  	.turtle {
  		border: 1px solid #333;
  		border-radius: 3px;
  		padding: 1em;
  	}

  	.turtles {
  		margin: 1em;
  		padding: 1em;
  		border-bottom: 1px solid green;
  	}

  	img {
  		width: 1em;
  		height: 1em;
  	}
  </style>
</head>
<body>
	<!--turtle template is read by jQuery and injected with turtle info then appened to div with the id output-->
	<div id="turtleTemplate" style="display: none">
		<div class="col-md-3">
			<div class="turtle">
				<h3 class="turtle_name"></h3>
				<p class="turtle_weapon"></p>
				<h4 class="turtle_pizza">I've had this many pizzas:</h4>
				<button type="submit" class="buy_pizza btn btn-success">Buy me a pizza!</button>
				<!--fix this?-->
				<button type="submit" class="delete_turtle btn btn-danger">Send me away ðŸ˜“</button>
			</div>
		</div>
	</div>
	<!--the login displayed html-->
	<div class="container login-form" style="display: none">
		<div class="row">
			<div class="col-sm-4 col-sm-offset-4">
				<div id="login-error"></div>
				<input type="text" id="username">
				<input type="text" id="password">
				<button class="btn btn-info" id="login">Login</button>
				<button class="btn btn-warning" id="register">Register</button>
			</div>
		</div>
	</div>
	<!--the html that gets injected with the turtleDiv-->
	<div class="container">
		<div class="turtles">
			<div id="output" class="row"></div>
		</div>
	</div>
	<!--the html for the turtle input form-->
	<div class="container">
		<div class="row">
			<div class="col-sm-4 col-sm-offset-4">
				Turtle Name: <input type="text" id="newTurtleName" class="form-control">
				Turtle Color: <input type="text" id="newTurtleColor" class="form-control">
				Turtle Weapon: <input type="text" id="newTurtleWeapon" class="form-control">
				<button class="btn btn-info" id="newTurtleSubmit">Submit Turtle</button>
			</div>
		</div>
	</div>
	<script>
		/*
			Function to get the turtles from the server
		*/
		function getTurtles() {
			// get request to get the turtles
			// I've rewritten this as an $.ajax call to handle the error state
			$.ajax({
				method: "GET",
				url: '/api/turtles',
				success: function(response){
					// when we get a response, wipe out all of the turtle divs
					$('#output').empty();
					// and rebuild all of them as clones of the turtle template
					for (var i = 0; i < response.length; i++) {
						var turtleDiv = $('#turtleTemplate').children().first().clone();
						turtleDiv.find('.turtle_name').text(response[i].name);
						turtleDiv.find('.turtle_weapon').text(response[i].weapon);
						turtleDiv.find('.turtle_pizza').text("I've had this many pizzas: " + response[i].pizza);
						/*if (response[i].pizza !== 0) {
							for (var j = 1; j < response[i].pizza; j++) {
								$('.turtle_pizza').data(response[i]._id).append(' <img src="http://www.free-icons-download.net/images/pizza-icon-65951.png">');
							}
						}*/ //can't figure out how to select the correct turtle
						turtleDiv.find('.buy_pizza').data('turtleID', response[i]._id);
						turtleDiv.find('.delete_turtle').data('turtleID', response[i]._id);
						turtleDiv.css({color: response[i].color});
						// If you do this, make sure you actually put the clone into the DOM!
						$('#output').append(turtleDiv);
					}
					addListeners();
				},
				error: function(err) {
					// On an error (unable to get the turtles), show the login form
					$('.login-form').show();
				}
			});
		}

		/*
			Click listener for adding a new turtle
		*/
		$('#newTurtleSubmit').click(function() {
			// post the turtle
			// todo: add some validation here
			$.post('/api/newTurtle', {
				name: $('#newTurtleName').val(),
				color: $('#newTurtleColor').val(),
				weapon: $('#newTurtleWeapon').val()
			}, function() {
				// on success, clear out the existing turtle inputs
				$('#newTurtleName').val('');
				$('#newTurtleColor').val('');
				$('#newTurtleWeapon').val('');
				// and re-build the turtles div from the database
				getTurtles();
			});
		});
		// get the turtles on page load
		$(document).ready(function() {
			getTurtles();
		});
		
		function addListeners() {
			//even handler for clicking buy pizza button
			$('.buy_pizza').click(function() {
				var turtle_id = $(this).data('turtleID');
				$.post('/api/buyPizza', {
					_id: turtle_id
				}, function(res) {
					if (res === "error") {
						console.log('500 server error!');
					} else {
						getTurtles();
					}
				});
			});
			//event handler for clicking delete button
			
			$('.delete_turtle').click(function() {
				var turtle_id = $(this).data("turtleID");
				$.post('/api/deleteTurtle', {
					id: turtle_id
				}, function(res) {
					if (res ==="error"){
						console.log("500 server error!");
					} else {
						getTurtles();
						alert(res);
					}
				});
			});
		}
		/*
			Click listener for the login button
		*/
		$('#login').click(function() {
			// post to the login api
			$.post('/api/login', {
				username: $('#username').val(),
				password: $('#password').val()
			}, function(res) {
				// If we haven't logged in, display an error
				if (res === "error") {
					$('#login-error').text('Error: Username or password incorrect.');
				} else {
					// Otherwise, hide the login form and get the turtles
					$('.login-form').hide();
					getTurtles();
				}
			});
		});

		/*
			Click listener for registering a user
		*/
		$('#register').click(function() {
			// todo: add validation
			$.post('/api/register', {
				username: $('#username').val(),
				password: $('#password').val()
			}, function(res) {
				// Display the result to the user
				if (res === "error") {
					$('#login-error').text('Error: Could not register user.');
				} else {
					$('#login-error').text('Registered! Try logging in...');
				}
			});
		});
	</script>
</body>
</html>
